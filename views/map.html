{% extends "layout.html" %}

{% block title %}Carte des camÃ©ras - SmartCam{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="map-page">
    <h2>Carte interactive des camÃ©ras</h2>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <div class="map-legend">
        <h4>LÃ©gende</h4>
        <div class="legend-item">
            <span class="marker active">ï¿½</span> CamÃ©ra active
        </div>
        <div class="legend-item">
            <span class="marker inactive">âš«</span> CamÃ©ra inactive
        </div>
        <div class="legend-item">
            <span class="marker error">ï¿½</span> CamÃ©ra en erreur
        </div>
        <div class="legend-item">
            <span class="marker maintenance">ðŸŸ </span> CamÃ©ra en maintenance
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize map
    const map = L.map('map').setView([48.8566, 2.3522], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Fetch and display cameras
    fetch('/api/cameras')
        .then(response => response.json())
        .then(cameras => {
            cameras.forEach(camera => {
                // Get position info if available
                if (camera.fk_position) {
                    fetch(`/api/positions/${camera.fk_position}`)
                        .then(response => response.json())
                        .then(position => {
                            // Choose icon based on camera status
                            let iconHtml = 'ðŸ“¹'; // Default camera icon
                            let iconColor = '#666'; // Default color
                            
                            switch(camera.status) {
                                case 'active':
                                    iconHtml = 'ðŸŸ¢';
                                    iconColor = '#27ae60';
                                    break;
                                case 'inactive':
                                    iconHtml = 'âš«';
                                    iconColor = '#7f8c8d';
                                    break;
                                case 'error':
                                    iconHtml = 'ðŸ”´';
                                    iconColor = '#e74c3c';
                                    break;
                                case 'maintenance':
                                    iconHtml = 'ðŸŸ ';
                                    iconColor = '#f39c12';
                                    break;
                            }
                            
                            const icon = L.divIcon({
                                html: `<div style="font-size: 24px;">${iconHtml}</div>`,
                                className: `camera-marker ${camera.status}`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15],
                                popupAnchor: [0, -15]
                            });
                            
                            const marker = L.marker([position.latitude, position.longitude], { icon })
                                .addTo(map);
                            
                            marker.bindPopup(`
                                <div class="camera-popup">
                                    <h4>CamÃ©ra #${camera.id}</h4>
                                    <p><strong>IP:</strong> ${camera.ip}</p>
                                    <p><strong>Statut:</strong> <span class="status ${camera.status}">${camera.status}</span></p>
                                    <p><strong>Emplacement:</strong> ${position.label || 'Non dÃ©fini'}</p>
                                    <a href="/cameras/${camera.id}" class="btn btn-sm">Voir dÃ©tails</a>
                                </div>
                            `);
                        });
                }
            });
        })
        .catch(error => console.error('Erreur lors du chargement des camÃ©ras:', error));
</script>
{% endblock %}
